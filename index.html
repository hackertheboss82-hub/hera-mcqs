<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Hera MCQ System</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body { font-family: Arial; background:#f4f6f8; }
.box {
  width:360px; margin:40px auto; padding:20px;
  background:#fff; border-radius:8px; box-shadow:0 0 10px #ccc;
}
input, select, button {
  width:100%; padding:10px; margin-top:10px;
}
button { cursor:pointer; }
#teacherPanel, #testArea { display:none; }
.error { color:red; }
</style>
</head>

<body>

<!-- TEACHER LOGIN -->
<div class="box" id="loginBox">
<h2>Teacher Login</h2>
<input id="tEmail" placeholder="Email">
<input id="tPassword" type="password" placeholder="Password">
<button onclick="teacherLogin()">Login</button>
<p id="loginMsg" class="error"></p>
</div>

<!-- TEACHER PANEL -->
<div class="box" id="teacherPanel">
<h3>Student Results</h3>

<select id="resultClassSelect" onchange="TestsForClass(this.value)"></select>
<select id="resultTestSelect"></select>
<button onclick="Results()">Results</button>
<div id="resultBox"></div>

<hr>

<h3>Create Test</h3>
<select id="testClass">
<option value="">Select Class</option>
<option value="8">Class 8</option>
<option value="9">Class 9</option>
<option value="10">Class 10</option>
</select>

<input id="testName" placeholder="Test Name">
<input id="testDuration" type="number" placeholder="Duration (minutes)">
<input id="questionLimit" type="number" placeholder="Questions to show (e.g. 30)">
<textarea id="bulkQuestions" rows="6"
placeholder="Question | A | B | C | D | CorrectIndex"></textarea>

<button onclick="saveTest()">Save Test</button>

<hr>

<h3>Manage Tests</h3>
<select id="manageClass" onchange="TestsForTeacher()">
<option value="">Select Class</option>
<option value="8">Class 8</option>
<option value="9">Class 9</option>
<option value="10">Class 10</option>
</select>

<div id="testList"></div>
<button onclick="logout()">Logout</button>
</div>

<!-- STUDENT PANEL -->
<div class="box" id="studentPanel">
<h3>Student Test Portal</h3>
<input id="sName" placeholder="Student Name">
<input id="sRoll" placeholder="Roll Number">

<select id="sClass" onchange="TestsForClass(this.value)">
<option value="">Select Class</option>
<option value="8">Class 8</option>
<option value="9">Class 9</option>
<option value="10">Class 10</option>
</select>

<select id="studentTestSelect">
<option value="">Select Test</option>
</select>

<button onclick="startStudentTest()">Start Test</button>
</div>

<!-- TEST AREA -->
<div id="testArea">
<h3 id="testTitle"></h3>
<h4 id="timerBox" style="color:red"></h4>
<div id="questionBox"></div>
<button id="submitBtn" onclick="submitTest()">Submit</button>
</div>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyBQ2-dTUTPwhf7WqceEwXpk9CtPksR1xCk",
  authDomain: "hera-mcqs-55022.firebaseapp.com",
  databaseURL: "https://hera-mcqs-55022-default-rtdb.firebaseio.com"
});

const auth = firebase.auth();
let currentStudent={}, currentTest="", currentQuestions=[], studentAnswers={};
let timerInterval = null;
let remainingTime = 0; // seconds
let autoSaveInterval = null;

window.onbeforeunload = function () {
  if (testArea.style.display === "block") {
    return "Test is running. Leaving will submit the test.";
  }
};

window.onload = () => {
  studentPanel.style.display = "block";
};

/* LOGIN */
function teacherLogin(){
  auth.signInWithEmailAndPassword(
    tEmail.value,
    tPassword.value
  ).catch(e => loginMsg.innerText = e.message);
}

auth.onAuthStateChanged(u=>{
  loginBox.style.display = u ? "none" : "block";
  teacherPanel.style.display = u ? "block" : "none";
  if(u) ResultClasses();
});

function ResultClasses(){
  firebase.database().ref("results").once("value", snap => {

    resultClassSelect.innerHTML =
      "<option value=''>Select Class</option>";

    if(!snap.exists()) return;

    snap.forEach(cls => {
      let opt = document.createElement("option");
      opt.value = cls.key.replace("class_","");
      opt.textContent = cls.key.replace("class_","");
      resultClassSelect.appendChild(opt);
    });
  });
}

function TestsForClass(cls){
  resultTestSelect.innerHTML="<option value=''>Select Test</option>";
  studentTestSelect.innerHTML="<option value=''>Select Test</option>";

  firebase.database().ref(`tests/class_${cls}`).once("value", snap=>{
    snap.forEach(t=>{
      let o=document.createElement("option");
      o.value=o.text=t.key;
      resultTestSelect.appendChild(o.cloneNode(true));
      studentTestSelect.appendChild(o);
    });
  });
}

/* SAVE TEST */
function saveTest(){
  const cls = testClass.value;
  const name = testName.value.trim();
  const raw = bulkQuestions.value.trim();
  const duration = Number(testDuration.value);
  const limit = Number(questionLimit.value);

  if(!cls || !name || !raw || !duration || !limit){
    alert("Fill all fields including duration");
    return;
  }

  const questions = raw.split("\n").map(l=>{
    const p = l.split("|");
    return {
      q: p[0].trim(),
      options: p.slice(1,5).map(x=>x.trim()),
      answer: Number(p[5])
    };
  });

  firebase.database()
    .ref(`tests/class_${cls}/${name}`)
    .set({
      duration: duration,
      limit: limit,
      questions: questions
    })
    .then(()=>{
      alert("Test Saved with duration");
      testName.value="";
      bulkQuestions.value="";
      testDuration.value="";
      questionLimit.value="";
    });
}
function autoSaveAnswers(){
  if(!currentStudent.roll || !currentTest) return;

  firebase.database()
    .ref(`autosave/class_${currentStudent.class}/${currentTest}/${currentStudent.roll}`)
    .set({
      answers: studentAnswers,
      timeLeft: remainingTime,
      savedAt: Date.now()
    });
}

function shuffleArray(arr){
  for(let i = arr.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

/* STUDENT TESTS */
function startStudentTest(){

  const cls = sClass.value;
  const test = studentTestSelect.value;
  const roll = sRoll.value;
  const name = sName.value;

  if (!cls || !test || !roll || !name) {
    alert("Please fill all details");
    return;
  }

  // ðŸ”’ Check if already attempted
  firebase.database()
    .ref(`results/class_${cls}/${test}/${roll}`)
    .once("value")
    .then(rSnap => {

      if (rSnap.exists()) {
        alert("Test already submitted.\nTeacher must allow reattempt.");
        return;
      }

      // âœ… Load test
      currentStudent = { name, roll, class: cls };
      currentTest = test;

      firebase.database()
        .ref(`tests/class_${cls}/${test}`)
        .once("value", snap => {

          if (!snap.exists()) {
            alert("Test not found");
            return;
          }

          const data = snap.val();

         let allQuestions = Object.values(data.questions || {});

          // ðŸ”€ Shuffle
          shuffleArray(allQuestions);

          // âœ‚ï¸ Apply teacher limit
          const limit = data.limit || allQuestions.length;
          currentQuestions = allQuestions.slice(0, limit);

         studentAnswers = {};

// â™»ï¸ Restore auto-saved answers if exist
firebase.database()
  .ref(`autosave/class_${cls}/${test}/${roll}`)
  .once("value")
  .then(snap => {

    if(snap.exists()){
      const saved = snap.val();
      studentAnswers = saved.answers || {};
      remainingTime = saved.timeLeft || (data.duration * 60);
    } else {
      remainingTime = data.duration * 60;
    }

    startTimer(Math.ceil(remainingTime / 60));
    renderTest();

    // ðŸ” Start auto-save every 5 seconds
    autoSaveInterval = setInterval(autoSaveAnswers, 5000);
  });


function renderTest(){
  testTitle.innerText = `${currentTest} (${currentQuestions.length} Questions)`;
  studentPanel.style.display="none";
  testArea.style.display="block";
  questionBox.innerHTML="";
  currentQuestions.forEach((q,i)=>{
    questionBox.innerHTML+=`<b>${i+1}. ${q.q}</b><br>`+
    q.options.map((o,j)=>`<label>
    <input type="radio" name="q${i}" onchange="studentAnswers[${i}]=${j}">${o}
    </label><br>`).join("")+"<hr>";
  });
}

function startTimer(minutes){
  clearInterval(timerInterval);

  remainingTime = minutes * 60;
  updateTimerDisplay();

  timerInterval = setInterval(() => {
    remainingTime--;

    updateTimerDisplay();

    if (remainingTime <= 0) {
      clearInterval(timerInterval);
      alert("Time is up! Test will be submitted automatically.");
      submitTest();
    }
  }, 1000);
}

function updateTimerDisplay(){
  const min = Math.floor(remainingTime / 60);
  const sec = remainingTime % 60;
  timerBox.innerText = `Time Left: ${min}:${sec.toString().padStart(2,'0')}`;
}

function submitTest(){
clearInterval(autoSaveInterval);
clearInterval(timerInterval);

  // âœ… Disable reload warning before submitting
  disableUnloadWarning();

  let score = 0;

  currentQuestions.forEach((q, i) => {
    if (studentAnswers[i] === q.answer) score++;
  });

  firebase.database()
    .ref(`results/class_${currentStudent.class}/${currentTest}/${currentStudent.roll}`)
    .set({
      name: currentStudent.name,
      score: score,
      total: currentQuestions.length,
      time: Date.now()
    })
    .then(() => {
      alert("Test submitted successfully");
      firebase.database()
  .ref(`autosave/class_${currentStudent.class}/${currentTest}/${currentStudent.roll}`)
  .remove();
      location.reload();
    });
}


function Results(){
  const cls = resultClassSelect.value;
  const test = resultTestSelect.value;
  if(!cls || !test) return alert("Select class and test");

  firebase.database()
    .ref(`results/class_${cls}/${test}`)
    .once("value", snap => {

      resultBox.innerHTML = "";

      if(!snap.exists()){
        resultBox.innerHTML = "<p>No results</p>";
        return;
      }

      snap.forEach(r => {
        const d = r.val();

        resultBox.innerHTML += `
          <div style="border:1px solid #ccc;padding:6px;margin:6px">
            <b>${d.name}</b> (Roll: ${r.key})<br>
            Score: ${d.score}/${d.total}<br>
            <button onclick="allowReattempt('${cls}','${test}','${r.key}')">
              Allow Reattempt
            </button>
          </div>
        `;
      });
    });
}

function allowReattempt(cls, test, roll){
  if(!confirm("Allow this student to reattempt the test?")) return;

  firebase.database()
    .ref(`results/class_${cls}/${test}/${roll}`)
    .remove()
    .then(() => {
      alert("Reattempt allowed. Student can start test again.");
      Results(); // refresh list
    });
}

function TestsForTeacher() {
  const cls = manageClass.value;
  const testList = document.getElementById("testList");
  testList.innerHTML = "";
  if (!cls) return;

  firebase.database()
    .ref(`tests/class_${cls}`)
    .once("value", snap => {

      if (!snap.exists()) {
        testList.innerHTML = "<p>No tests found.</p>";
        return;
      }

      snap.forEach(t => {
        testList.innerHTML += `
          <div style="border:1px solid #ccc;padding:6px;margin:5px">
            <b>${t.key}</b><br>
            <button onclick="editTest('${cls}','${t.key}')">Edit</button>
            <button onclick="deleteTest('${cls}','${t.key}')">Delete</button>
          </div>
        `;
      });
    });
}

function editTest(cls, testName){
  firebase.database()
    .ref(`tests/class_${cls}/${testName}`)
    .once("value", snap=>{
      if(!snap.exists()) return;

      const data = snap.val();
      testClass.value = cls;
      testName.value = testName;
      testDuration.value = data.duration || "";
      questionLimit.value = data.limit || "";
      bulkQuestions.value = Object.values(data.questions)
        .map(q => `${q.q} | ${q.options.join(" | ")} | ${q.answer}`)
        .join("\n");
    });
}
function disableUnloadWarning(){
  window.onbeforeunload = null;
}

function deleteTest(cls, testName){
  if(confirm("Delete this test?")){
    firebase.database().ref(`tests/class_${cls}/${testName}`).remove().then(()=>alert("Deleted"));
  }
}

function logout(){ auth.signOut(); }
</script>

</body>
</html>

