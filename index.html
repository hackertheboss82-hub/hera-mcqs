<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>HERA MCQ TEST SYSTEM</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: Arial; margin: 0; background: #f4f6fb; }
        .hidden { display: none; }
        button { padding: 10px 15px; font-size: 15px; cursor: pointer; border-radius: 6px; border: none; background: #2563eb; color: #fff; }
        button:hover { background: #1e40af; }
        input, select, textarea { padding: 8px; width: 100%; margin: 5px 0; font-size: 14px; }
        .card { background: #fff; padding: 15px; border-radius: 10px; margin: 10px auto; max-width: 900px; box-shadow: 0 4px 10px rgba(0,0,0,.1); }
        h2 { text-align: center; }
        .option { display: flex; align-items: center; margin: 8px 0; padding: 8px; border: 1px solid #ccc; border-radius: 6px; }
        .option input { width: 20px; height: 20px; margin-right: 10px; }
        .palette button { width: 38px; height: 38px; margin: 4px; border-radius: 50%; }
        .palette .done { background: green; }
        .palette .current { background: orange; }
        .palette .pending { background: #ddd; color: #000; }
        .timer { font-weight: bold; color: #dc2626; text-align: center; }
        .progress { height: 10px; margin-bottom: 20px; }
        .modal-body { max-height: 400px; overflow-y: auto; }
        /* Cheating prevention */
        body { -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; }
    </style>
</head>
<body oncontextmenu="return false;" oncopy="return false;" onpaste="return false;" oncut="return false;" onblur="pauseTimer()" onfocus="resumeTimer()" onbeforeunload="return 'Are you sure you want to leave? Your progress may be lost.';">
    <header class="bg-primary text-white p-3 text-center">
        <h2>ðŸ“˜ HERA MCQ TEST SYSTEM</h2>
    </header>

    <div class="container my-4">
        <div class="card" id="loginBox">
            <h2>Login</h2>
            <select id="role" class="form-select mb-2">
                <option value="student">Student</option>
                <option value="teacher">Teacher</option>
            </select>
            <input id="name" class="form-control mb-2" placeholder="Name" required>
            <input id="class" class="form-control mb-2" placeholder="Class (JR to 10)" required>
            <input id="pin" type="password" class="form-control mb-2" placeholder="Teacher PIN (only for teacher)">
            <button class="btn btn-primary" onclick="login()">Login</button>
        </div>

        <div class="card hidden" id="teacherPanel">
            <h2>Teacher Panel</h2>
            <h5>Manage Students</h5>
            <input id="newSName" class="form-control mb-2" placeholder="Student Name">
            <input id="newSPass" type="password" class="form-control mb-2" placeholder="Password">
            <select id="newSClass" class="form-select mb-2">
                <option>JR</option><option>SR</option><option>1</option><option>2</option>
                <option>3</option><option>4</option><option>5</option>
                <option>6</option><option>7</option><option>8</option>
                <option>9</option><option>10</option>
            </select>
            <button class="btn btn-primary mb-3" onclick="addStudent()">Add Student</button>

            <h5>Create / Edit Test</h5>
            <input id="testTitle" class="form-control mb-2" placeholder="Test Title" required>
            <select id="testClass" class="form-select mb-2">
                <option>JR</option><option>SR</option><option>1</option><option>2</option>
                <option>3</option><option>4</option><option>5</option>
                <option>6</option><option>7</option><option>8</option>
                <option>9</option><option>10</option>
            </select>
            <input id="testTime" type="number" class="form-control mb-2" placeholder="Time (minutes)" min="1" required>
            <textarea id="questions" class="form-control mb-2" rows="12" placeholder="PASTE QUESTIONS FORMAT:

Question
Option1
Option2
Option3
Option4
CorrectIndex (0-3)

(blank line)
"></textarea>
            <button class="btn btn-warning me-2" onclick="previewTest()">Preview</button>
            <button class="btn btn-success" onclick="createTest()">Save Test</button>

            <h3>Your Tests</h3>
            <div id="teacherTests"></div>

            <h3>Attempts</h3>
            <select id="classFilter" class="form-select mb-2" onchange="loadAttempts()">
                <option value="">All Classes</option>
                <option>JR</option><option>SR</option><option>1</option><option>2</option>
                <option>3</option><option>4</option><option>5</option>
                <option>6</option><option>7</option><option>8</option>
                <option>9</option><option>10</option>
            </select>
            <button class="btn btn-outline-primary mb-2" onclick="exportAttempts()">Export CSV</button>
            <div id="attempts"></div>

            <button class="btn btn-secondary mt-3" onclick="logout()">Logout</button>
        </div>

        <div class="card hidden" id="studentPanel">
            <h2 id="testName"></h2>
            <div id="timer" class="timer mb-2"></div>
            <div class="progress">
                <div class="progress-bar" id="progressBar" style="width: 0%"></div>
            </div>
            <div id="questionBox"></div>
            <div id="navBtns" class="d-flex justify-content-between mt-3">
                <button class="btn btn-secondary" onclick="prevQ()">Previous</button>
                <button class="btn btn-info" onclick="reviewTest()">Review</button>
                <button class="btn btn-secondary" onclick="nextQ()">Next</button>
                <button class="btn btn-danger" onclick="confirmSubmit()">Submit</button>
            </div>
            <div class="palette" id="palette"></div>
        </div>
    </div>

    <footer class="text-center p-3 bg-light">
        <p>&copy; 2023 HERA MCQ System. All rights reserved.</p>
    </footer>

    <!-- Modals -->
    <div class="modal fade" id="errorModal" tabindex="-1">
        <div class="modal-dialog"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Error</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body" id="errorMessage"></div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div>
        </div></div>
    </div>

    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Confirm</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body" id="confirmMessage"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmAction">Confirm</button>
            </div>
        </div></div>
    </div>

    <div class="modal fade" id="resultModal" tabindex="-1">
        <div class="modal-dialog modal-lg"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Results</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body" id="resultContent"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" onclick="downloadPDF()">Download PDF</button>
            </div>
        </div></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBQ2-dTUTPwhf7WqceEwXpk9CtPksR1xCk",
            authDomain: "hera-mcqs-55022.firebaseapp.com",
            databaseURL: "https://hera-mcqs-55022-default-rtdb.firebaseio.com",
            projectId: "hera-mcqs-55022",
            storageBucket: "hera-mcqs-55022.firebasestorage.app",
            messagingSenderId: "878791404574",
            appId: "1:878791404574:web:a0ec3ab2819423aa09120f"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let role, userName, userClass, currentTest = {}, qIndex = 0, answers = {}, timerInt, timeLeft, editId = null, pausedTime = 0, resultData = {};
        let autoSaveInterval;

        function showError(message) { document.getElementById('errorMessage').textContent = message; new bootstrap.Modal(document.getElementById('errorModal')).show(); }
        function showConfirm(message, action) { document.getElementById('confirmMessage').textContent = message; document.getElementById('confirmAction').onclick = action; new bootstrap.Modal(document.getElementById('confirmModal')).show(); }

        function login() {
            role = document.getElementById("role").value;
            userName = name.value.trim();
            userClass = class.value.trim();
            if (!userName) return showError("Enter name");

            if (role === "teacher") {
                if (pin.value !== "1914") return showError("Wrong PIN");
                loginBox.classList.add("hidden");
                teacherPanel.classList.remove("hidden");
                loadTeacherTests();
                loadAttempts();
            } else {
                loadStudentTest();
            }
        }

        function logout() { location.reload(); }

        function addStudent() {
            let name = newSName.value.trim(), pass = newSPass.value.trim(), cls = newSClass.value;
            if (!name || !pass) return showError("Enter name and password.");
            db.ref("students").push({ name, password: pass, class: cls, createdBy: userName }).then(() => {
                alert("Student added!");
                newSName.value = ""; newSPass.value = "";
            }).catch(e => showError("Failed: " + e.message));
        }

        function parseQuestions(text) {
            let blocks = text.trim().split(/\n\s*\n/);
            let qs = [];
            blocks.forEach(b => {
                let l = b.split("\n").map(x => x.trim()).filter(x => x);
                if (l.length >= 6) {
                    let ans = parseInt(l[5]);
                    if (isNaN(ans) || ans < 0 || ans > 3) return showError("Correct index must be 0-3.");
                    qs.push({ q: l[0], opts: l.slice(1, 5), ans });
                }
            });
            if (qs.length === 0) throw "No valid questions found.";
            return qs;
        }

        function previewTest() {
            try {
                let qs = parseQuestions(questions.value);
                let preview = qs.slice(0, 5).map((q, i) => `<p><strong>Q${i+1}:</strong> ${q.q}<br>Options: ${q.opts.join(', ')}<br>Correct: ${q.opts[q.ans]}</p>`).join('');
                showError("Preview (first 5):\n" + preview);
            } catch (e) { showError(e); }
        }

        function createTest() {
            try {
                let qs = parseQuestions(questions.value);
                let data = {
                    title: testTitle.value,
                    class: testClass.value,
                    time: +testTime.value,
                    questions: qs,
                    createdBy: userName
                };
                let path = editId ? `tests/${data.class}/${editId}` : `tests/${data.class}/${data.title}`;
                db.ref(path).set(data).then(() => {
                    alert("Test Saved");
                    editId = null;
                    loadTeacherTests();
                }).catch(e => showError("Save failed: " + e.message));
            } catch (e) { showError(e); }
        }

        function loadTeacherTests() {
            teacherTests.innerHTML = "";
            db.ref("tests").once("value", s => {
                s.forEach(c => {
                    c.forEach(t => {
                        let d = t.val();
                        if (d.createdBy === userName) {
                            let div = document.createElement("div");
                            div.innerHTML = `${d.title} (${c.key})
                            <button onclick="editTest('${c.key}','${d.title}')">Edit</button>
                            <button onclick="deleteTest('${c.key}','${d.title}')">Delete</button>`;
                            teacherTests.appendChild(div);
                        }
                    });
                });
            }).catch(e => showError("Failed to load tests: " + e.message));
        }

        function editTest(cls, title) {
            db.ref(`tests/${cls}/${title}`).once("value", s => {
                let d = s.val();
                editId = title;
                testTitle.value = d.title;
                testClass.value = d.class;
                testTime.value = d.time;
                questions.value = d.questions.map(q => [q.q, ...q.opts, q.ans].join("\n")).join("\n\n");
            }).catch(e => showError("Failed to load test: " + e.message));
        }

        function deleteTest(cls, title) {
            showConfirm("Delete test?", () => {
                db.ref(`tests/${cls}/${title}`).remove().then(loadTeacherTests).catch(e => showError("Delete failed: " + e.message));
            });
        }

        function loadStudentTest() {
            db.ref("tests/" + userClass).limitToFirst(1).once("value", s => {
                if (!s.exists()) return showError("No test available.");
                let key = Object.keys(s.val())[0];
                currentTest = s.val()[key];
                startTest();
            }).catch(e => showError("Failed to load test: " + e.message));
        }

        function startTest() {
            // Check attempt
            db.ref("attempts").orderByChild("student").equalTo(userName).once("value", s => {
                let attempted = false;
                s.forEach(a => { if (a.val().test === currentTest.title) attempted = true; });
                if (attempted) return showError("Already attempted.");
                loginBox.classList.add("hidden");
                studentPanel.classList.remove("hidden");
                currentTest.questions = shuffle(currentTest.questions).slice(0, 30);
                timeLeft =
