<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Hera MCQ System</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body { font-family: Arial; background:#f4f6f8; }
.box {
  width:360px; margin:40px auto; padding:20px;
  background:#fff; border-radius:8px; box-shadow:0 0 10px #ccc;
}
input, select, button {
  width:100%; padding:10px; margin-top:10px;
}
button { cursor:pointer; }
#teacherPanel, #testArea { display:none; }
.error { color:red; }
.success { color:green; }
</style>
</head>

<body>

<!-- TEACHER LOGIN -->
<div class="box" id="loginBox">
<h2>Teacher Login</h2>
<input id="tEmail" placeholder="Email">
<input id="tPassword" type="password" placeholder="Password">
<button onclick="teacherLogin()">Login</button>
<p id="loginMsg" class="error"></p>
</div>

<!-- TEACHER PANEL -->
<div class="box" id="teacherPanel">
  <h3>Student Results</h3>

<select id="resultClassSelect"></select>
<select id="resultTestSelect"></select>

<button onclick="loadResults()">Load Results</button>

<div id="resultBox"></div>
<h3>Create Test</h3>

<select id="testClass">
<option value="">Select Class</option>
<option value="8">Class 8</option>
<option value="9">Class 9</option>
<option value="10">Class 10</option>
</select>

<input id="testName" placeholder="Test Name">

<textarea id="bulkQuestions" rows="6"
placeholder="Question | A | B | C | D | CorrectIndex"></textarea>

<button onclick="saveTest()">Save Test</button>
<p id="saveMsg"></p>

<hr>

<h3>Manage Tests</h3>
<select id="manageClass" onchange="loadTestsForTeacher()">
<option value="">Select Class</option>
<option value="8">Class 8</option>
<option value="9">Class 9</option>
<option value="10">Class 10</option>
</select>

<div id="testList"></div>
<button onclick="logout()">Logout</button>
</div>

<!-- STUDENT PANEL -->
<div class="box" id="studentPanel">
  
<h3>Student Test Portal</h3>

<input id="sName" placeholder="Student Name">
<input id="sRoll" placeholder="Roll Number">

<select id="sClass" onchange="loadStudentTests()">
<option value="">Select Class</option>
<option value="8">Class 8</option>
<option value="9">Class 9</option>
<option value="10">Class 10</option>
</select>

<select id="studentTestSelect">
<option value="">Select Test</option>
</select>

<button onclick="startStudentTest()">Start / Resume Test</button>
</div>

<!-- TEST AREA -->
<div id="testArea" style="display:none">
  <h3 id="testTitle"></h3>
  <div id="questionBox"></div>

  <button onclick="submitTest()" style="margin-top:20px;background:#2e7d32;color:white">
    Submit Test
  </button>
</div>

<script>
firebase.initializeApp({
 apiKey:"AIzaSyBQ2-dTUTPwhf7WqceEwXpk9CtPksR1xCk",
 authDomain:"hera-mcqs-55022.firebaseapp.com",
 databaseURL:"https://hera-mcqs-55022-default-rtdb.firebaseio.com"
});

const auth = firebase.auth();
let currentStudent={}, currentTest="", currentQuestions=[], studentAnswers={};
let score = 0;
let totalQuestions = 0;
let correctCount = 0;
let wrongCount = 0;

// âœ… FIX: Show student panel by default
window.onload = () => {
  studentPanel.style.display = "block";
};

/* LOGIN */
function teacherLogin(){
 auth.signInWithEmailAndPassword(
  tEmail.value, tPassword.value
 ).catch(e=>loginMsg.innerText=e.message);
}

auth.onAuthStateChanged(u=>{
 loginBox.style.display = u ? "none":"block";
 teacherPanel.style.display = u ? "block":"none";

 if(u){
   loadResultClasses();
 }
});
resultClassSelect.onchange = function(){
  resultTestSelect.innerHTML = "";

  firebase.database()
    .ref(`tests/class_${this.value}`)
    .once("value", snap => {
      snap.forEach(t => {
        let o = document.createElement("option");
        o.value = o.text = t.key;
        resultTestSelect.appendChild(o);
      });
    });
};

function loadResultClasses() {
  resultClassSelect.innerHTML = "";
resultClassSelect.innerHTML = `<option value="">Select Class</option>`;

  firebase.database().ref("tests").once("value", snap => {
    snap.forEach(c => {
      if (c.key.startsWith("class_")) {
        let cls = c.key.replace("class_", "");
        let op = document.createElement("option");
        op.value = cls;
        op.text = cls;
        resultClassSelect.appendChild(op);
      }
    });
  });
}


/* SAVE TEST */
function saveTest(){
 const cls=testClass.value, name=testName.value.trim();
 const lines=bulkQuestions.value.trim().split("\n");
 let q=[];

 // âœ… FIX: Add validation for questions
 for(let l of lines){
  if(!l.includes("|")) continue;
  let p=l.split("|").map(x=>x.trim());
  if(p.length < 6) continue;
  if(isNaN(p[5])) continue;
  q.push({ q:p[0], options:p.slice(1,5), answer:+p[5] });
 }

 firebase.database().ref(`tests/class_${cls}/${name}`).set({questions:q});
 saveMsg.innerText="Saved âœ…";
}

/* LOAD STUDENT TESTS */
function loadStudentTests(){
 studentTestSelect.innerHTML="<option>Select Test</option>";
 firebase.database().ref(`tests/class_${sClass.value}`)
 .once("value").then(s=>{
  if(!s.exists())return;
  Object.keys(s.val()).forEach(t=>{
   let o=document.createElement("option");
   o.value=o.text=t;
   studentTestSelect.appendChild(o);
  });
 });
}

/* START / RESUME */
function startStudentTest(){

  const sName = document.getElementById("sName");
  const sRoll = document.getElementById("sRoll");
  const sClass = document.getElementById("sClass");
  const testSelect = document.getElementById("studentTestSelect");

  if(!sName.value || !sRoll.value || !sClass.value || !testSelect.value){
    alert("Please fill all fields");
    return;
  }

  currentStudent = {
    name: sName.value,
    roll: sRoll.value,
    class: sClass.value
  };

  currentTest = testSelect.value;

 // âœ… FIX: Prevent starting if already submitted (enforce stop)
 firebase.database()
  .ref(`results/class_${currentStudent.class}/${currentTest}/${currentStudent.roll}`)
  .once("value")
  .then(rSnap=>{
    if(rSnap.exists()){
      alert("Test already submitted. Contact teacher.");
      throw "STOP";
    }
  });

 
  firebase.database()
    .ref(`tests/class_${currentStudent.class}/${currentTest}/questions`)
    .once("value")
    .then(qSnap => {

      if(!qSnap.exists()){
        alert("Questions not found");
        return;
      }

      // âœ… OBJECT â†’ ARRAY FIX
      currentQuestions = Object.values(qSnap.val());

      // âœ… LOAD SAVED ATTEMPT (RESUME)
      firebase.database()
        .ref(`attempts/class_${currentStudent.class}/${currentTest}/${currentStudent.roll}`)
        .once("value")
        .then(aSnap => {

          studentAnswers = aSnap.exists()
            ? aSnap.val().answers || {}
            : {};

          renderTest(); // ðŸ‘ˆ YOUR function
        });
    });
}

/* RENDER */
function renderTest(){

  studentPanel.style.display = "none";
  testArea.style.display = "block";

  testTitle.innerText = currentTest;
  questionBox.innerHTML = "";

  currentQuestions.forEach((q, i) => {

    let html = `<b>${i+1}. ${q.q}</b><br>`;

    q.options.forEach((o, j) => {
      html += `
        <label>
          <input type="radio"
            name="q${i}"
            ${studentAnswers[i] == j ? "checked" : ""}
            onchange="saveAns(${i},${j})">
          ${o}
        </label><br>`;
    });

    questionBox.innerHTML += html + "<hr>";
  });
}

  
function submitTest(){

  score = 0;
  correctCount = 0;
  wrongCount = 0;

  totalQuestions = currentQuestions.length;

  currentQuestions.forEach((q, i) => {
    if(studentAnswers[i] != null){
      if(studentAnswers[i] == q.answer){
        score++;
        correctCount++;
      } else {
        wrongCount++;
      }
    }
  });

  const resultData = {
    student: currentStudent,
    test: currentTest,
    total: totalQuestions,
    score: score,
    correct: correctCount,
    wrong: wrongCount,
    answers: studentAnswers,
    submittedAt: new Date().toISOString(),
    status: "submitted"
  };

  // âœ… SAVE RESULT FOR TEACHER
  firebase.database()
    .ref(`results/class_${currentStudent.class}/${currentTest}/${currentStudent.roll}`)
    .set(resultData);

  // âœ… LOCK ATTEMPT
  firebase.database()
    .ref(`attempts/class_${currentStudent.class}/${currentTest}/${currentStudent.roll}`)
    .set(resultData);

  alert(
    `Test Submitted!\n\n` +
    `Score: ${score}/${totalQuestions}\n` +
    `Correct: ${correctCount}\n` +
    `Wrong: ${wrongCount}`
  );

  location.reload();
}


function saveAns(i,v){
 studentAnswers[i]=v;
 firebase.database().ref(
  `attempts/class_${currentStudent.class}/${currentTest}/${currentStudent.roll}`
 ).update({ answers:studentAnswers });
}
function loadResults(){
  const cls = resultClassSelect.value;
  const test = resultTestSelect.value;

  resultBox.innerHTML = "";

  firebase.database()
    .ref(`results/class_${cls}/${test}`)
    .once("value", snap=>{
      snap.forEach(st=>{
        const d = st.val();

        resultBox.innerHTML += `
          <div style="border:1px solid #ccc;padding:8px;margin:5px">
            <b>${d.student.name}</b> (Roll: ${st.key})<br>
            Score: ${d.score}/${d.total}<br>
            <button onclick="allowReattempt('${cls}','${test}','${st.key}')">
              Allow Re-Attempt
            </button>
          </div>
        `;
      });
    });
}
function allowReattempt(cls, test, roll){

  if(!confirm("Allow student to re-attempt this test?")) return;

  // âŒ Remove result
  firebase.database()
    .ref(`results/class_${cls}/${test}/${roll}`)
    .remove();

  // âŒ Remove attempt (answers + lock)
  firebase.database()
    .ref(`attempts/class_${cls}/${test}/${roll}`)
    .remove();

  alert("Re-attempt allowed. Student can start test again.");
}

function loadTestsForTeacher() {
  const cls = manageClass.value;
  const testList = document.getElementById("testList");
  testList.innerHTML = "";
  if (!cls) return;

  firebase.database().ref(`tests/class_${cls}`).once("value", snap => {
    if (!snap.exists()) {
      testList.innerHTML = "<p>No tests found for this class.</p>";
      return;
    }
    snap.forEach(t => {
      testList.innerHTML += `<div>${t.key} <button onclick="deleteTest('${cls}', '${t.key}')">Delete</button></div>`;
    });
  });
}

function deleteTest(cls, testName) {
  if (confirm(`Delete test "${testName}"?`)) {
    firebase.database().ref(`tests/class_${cls}/${testName}`).remove();
    loadTestsForTeacher(); // Refresh list
  }
}

function logout(){ auth.signOut(); }
</script>
</body>
</html>
