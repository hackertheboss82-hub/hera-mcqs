<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Hera MCQ System</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body { font-family: Arial; background:#f4f6f8; }
.box {
  width:360px; margin:40px auto; padding:20px;
  background:#fff; border-radius:8px; box-shadow:0 0 10px #ccc;
}
input, select, button {
  width:100%; padding:10px; margin-top:10px;
}
button { cursor:pointer; }
#teacherPanel, #testArea { display:none; }
.error { color:red; }
.success { color:green; }
</style>
</head>

<body>

<!-- TEACHER LOGIN -->
<div class="box" id="loginBox">
<h2>Teacher Login</h2>
<input id="tEmail" placeholder="Email">
<input id="tPassword" type="password" placeholder="Password">
<button onclick="teacherLogin()">Login</button>
<p id="loginMsg" class="error"></p>
</div>

<!-- TEACHER PANEL -->
<div class="box" id="teacherPanel">
<h3>Create Test</h3>

<select id="testClass">
<option value="">Select Class</option>
<option value="8">Class 8</option>
<option value="9">Class 9</option>
<option value="10">Class 10</option>
</select>

<input id="testName" placeholder="Test Name">

<textarea id="bulkQuestions" rows="6"
placeholder="Question | A | B | C | D | CorrectIndex"></textarea>

<button onclick="saveTest()">Save Test</button>
<p id="saveMsg"></p>

<hr>

<h3>Manage Tests</h3>
<select id="manageClass" onchange="loadTestsForTeacher()">
<option value="">Select Class</option>
<option value="8">Class 8</option>
<option value="9">Class 9</option>
<option value="10">Class 10</option>
</select>

<div id="testList"></div>
<button onclick="logout()">Logout</button>
</div>

<!-- STUDENT PANEL -->
<div class="box" id="studentPanel">
<h3>Student Test Portal</h3>

<input id="sName" placeholder="Student Name">
<input id="sRoll" placeholder="Roll Number">

<select id="sClass" onchange="loadStudentTests()">
<option value="">Select Class</option>
<option value="8">Class 8</option>
<option value="9">Class 9</option>
<option value="10">Class 10</option>
</select>

<select id="studentTestSelect">
<option value="">Select Test</option>
</select>

<button onclick="startStudentTest()">Start / Resume Test</button>
</div>

<!-- TEST AREA -->
<div class="box" id="testArea">
<h3 id="testTitle"></h3>
<div id="questionBox"></div>
</div>

<script>
firebase.initializeApp({
 apiKey:"AIzaSyBQ2-dTUTPwhf7WqceEwXpk9CtPksR1xCk",
 authDomain:"hera-mcqs-55022.firebaseapp.com",
 databaseURL:"https://hera-mcqs-55022-default-rtdb.firebaseio.com"
});

const auth = firebase.auth();
let currentStudent={}, currentTest="", currentQuestions=[], studentAnswers={};

/* LOGIN */
function teacherLogin(){
 auth.signInWithEmailAndPassword(
  tEmail.value, tPassword.value
 ).catch(e=>loginMsg.innerText=e.message);
}

auth.onAuthStateChanged(u=>{
 loginBox.style.display = u ? "none":"block";
 teacherPanel.style.display = u ? "block":"none";
});

/* SAVE TEST */
function saveTest(){
 const cls=testClass.value, name=testName.value.trim();
 const lines=bulkQuestions.value.trim().split("\n");
 let q=[];

 for(let l of lines){
  let p=l.split("|").map(x=>x.trim());
  q.push({ q:p[0], options:p.slice(1,5), answer:+p[5] });
 }

 firebase.database().ref(`tests/class_${cls}/${name}`).set({questions:q});
 saveMsg.innerText="Saved âœ…";
}

/* LOAD STUDENT TESTS */
function loadStudentTests(){
 studentTestSelect.innerHTML="<option>Select Test</option>";
 firebase.database().ref(`tests/class_${sClass.value}`)
 .once("value").then(s=>{
  if(!s.exists())return;
  Object.keys(s.val()).forEach(t=>{
   let o=document.createElement("option");
   o.value=o.text=t;
   studentTestSelect.appendChild(o);
  });
 });
}

/* START / RESUME */
function startStudentTest(){
 currentStudent={
  name:sName.value, roll:sRoll.value, class:sClass.value
 };
 currentTest=studentTestSelect.value;

 firebase.database()
 .ref(`tests/class_${currentStudent.class}/${currentTest}/questions`)
 .once("value").then(qs=>{
  currentQuestions=qs.val();

 firebase.database()
 .ref(`attempts/class_${currentStudent.class}/${currentTest}/${currentStudent.roll}`)
 .once("value").then(a=>{
  studentAnswers = a.exists()?a.val().answers||{}:{};
  renderTest();
 });
 });
}

/* RENDER */
function renderTest(){
 studentPanel.style.display="none";
 testArea.style.display="block";
 testTitle.innerText=currentTest;
 questionBox.innerHTML="";

 currentQuestions.forEach((q,i)=>{
  let html=`<b>${i+1}. ${q.q}</b><br>`;
  q.options.forEach((o,j)=>{
   html+=`<label>
   <input type="radio" name="q${i}"
   ${studentAnswers[i]==j?"checked":""}
   onchange="saveAns(${i},${j})">${o}
   </label><br>`;
  });
  questionBox.innerHTML+=html+"<hr>";
 });
}

function saveAns(i,v){
 studentAnswers[i]=v;
 firebase.database().ref(
  `attempts/class_${currentStudent.class}/${currentTest}/${currentStudent.roll}`
 ).update({ answers:studentAnswers });
}

function logout(){ auth.signOut(); }
</script>
</body>
</html>
