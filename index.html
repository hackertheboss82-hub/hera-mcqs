<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Hera MCQ System</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body { font-family: Arial; background:#f4f6f8; }
.box {
  width:360px; margin:40px auto; padding:20px;
  background:#fff; border-radius:8px; box-shadow:0 0 10px #ccc;
}
input, select, button {
  width:100%; padding:10px; margin-top:10px;
}
button { cursor:pointer; }
#teacherPanel, #testArea { display:none; }
.error { color:red; }
</style>
</head>

<body>

<!-- TEACHER LOGIN -->
<div class="box" id="loginBox">
<h2>Teacher Login</h2>
<input id="tEmail" placeholder="Email">
<input id="tPassword" type="password" placeholder="Password">
<button onclick="teacherLogin()">Login</button>
<p id="loginMsg" class="error"></p>
</div>

<!-- TEACHER PANEL -->
<div class="box" id="teacherPanel">
<h3>Student Results</h3>

<select id="resultClassSelect"></select>
<select id="resultTestSelect"></select>
<button onclick="loadResults()">Results</button>
<div id="resultBox"></div>

<hr>

<h3>Create Test</h3>
<select id="testClass">
<option value="">Select Class</option>
<option value="8">Class 8</option>
<option value="9">Class 9</option>
<option value="10">Class 10</option>
</select>

<input id="testName" placeholder="Test Name">
<textarea id="bulkQuestions" rows="6"
placeholder="Question | A | B | C | D | CorrectIndex"></textarea>

<button onclick="saveTest()">Save Test</button>

<hr>

<h3>Manage Tests</h3>
<select id="manageClass" onchange="loadTestsForTeacher()">
<option value="">Select Class</option>
<option value="8">Class 8</option>
<option value="9">Class 9</option>
<option value="10">Class 10</option>
</select>

<div id="testList"></div>
<button onclick="logout()">Logout</button>
</div>

<!-- STUDENT PANEL -->
<div class="box" id="studentPanel">
<h3>Student Test Portal</h3>
<input id="sName" placeholder="Student Name">
<input id="sRoll" placeholder="Roll Number">

<select id="sClass" onchange="loadStudentTests()">
<option value="">Select Class</option>
<option value="8">Class 8</option>
<option value="9">Class 9</option>
<option value="10">Class 10</option>
</select>

<select id="studentTestSelect">
<option value="">Select Test</option>
</select>

<button onclick="startStudentTest()">Start Test</button>
</div>

<!-- TEST AREA -->
<div id="testArea">
<h3 id="testTitle"></h3>
<div id="questionBox"></div>
<button id="submitBtn" onclick="submitTest()">Submit</button>
</div>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyBQ2-dTUTPwhf7WqceEwXpk9CtPksR1xCk",
  authDomain: "hera-mcqs-55022.firebaseapp.com",
  databaseURL: "https://hera-mcqs-55022-default-rtdb.firebaseio.com"
});

const auth = firebase.auth();
let currentStudent={}, currentTest="", currentQuestions=[], studentAnswers={};

window.onload = () => {
  studentPanel.style.display = "block";
};

/* LOGIN */
function teacherLogin(){
  auth.signInWithEmailAndPassword(
    tEmail.value,
    tPassword.value
  ).catch(e => loginMsg.innerText = e.message);
}

auth.onAuthStateChanged(u=>{
  loginBox.style.display = u ? "none" : "block";
  teacherPanel.style.display = u ? "block" : "none";
  if(u) loadResultClasses();
});

function loadResultClasses(){
  resultClassSelect.innerHTML = "<option value=''>Select Class</option>";
  firebase.database().ref("tests").once("value", snap=>{
    snap.forEach(c=>{
      let o=document.createElement("option");
      o.value=c.key.replace("class_","");
      o.text=o.value;
      resultClassSelect.appendChild(o);
    });
  });
}

resultClassSelect.onchange = () => loadTestsForClass(resultClassSelect.value);

function loadTestsForClass(cls){
  resultTestSelect.innerHTML="<option value=''>Select Test</option>";
  studentTestSelect.innerHTML="<option value=''>Select Test</option>";

  firebase.database().ref(`tests/class_${cls}`).once("value", snap=>{
    snap.forEach(t=>{
      let o=document.createElement("option");
      o.value=o.text=t.key;
      resultTestSelect.appendChild(o.cloneNode(true));
      studentTestSelect.appendChild(o);
    });
  });
}

/* SAVE TEST */
function saveTest(){
  const cls=testClass.value;
  const name=testName.value.trim();
  const raw=bulkQuestions.value.trim();
  if(!cls||!name||!raw) return alert("Fill all fields");

  const questions=raw.split("\n").map(l=>{
    const p=l.split("|");
    return { q:p[0], options:p.slice(1,5), answer:+p[5] };
  });

  firebase.database().ref(`tests/class_${cls}/${name}`).set({questions})
  .then(()=>alert("Test Saved"));
}

/* STUDENT TESTS */
function loadStudentTests(){
  loadTestsForClass(sClass.value);
}

/* START TEST */
function startStudentTest(){
  currentStudent={name:sName.value,roll:sRoll.value,class:sClass.value};
  currentTest=studentTestSelect.value;

  firebase.database()
    .ref(`tests/class_${currentStudent.class}/${currentTest}/questions`)
    .once("value", snap=>{
      currentQuestions=Object.values(snap.val());
      renderTest();
    });
}

function renderTest(){
  studentPanel.style.display="none";
  testArea.style.display="block";
  questionBox.innerHTML="";
  currentQuestions.forEach((q,i)=>{
    questionBox.innerHTML+=`<b>${i+1}. ${q.q}</b><br>`+
    q.options.map((o,j)=>`<label>
    <input type="radio" name="q${i}" onchange="studentAnswers[${i}]=${j}">${o}
    </label><br>`).join("")+"<hr>";
  });
}

function submitTest(){
  alert("Test submitted");
  location.reload();
}

function loadResults(){
  firebase.database()
    .ref(`results/class_${resultClassSelect.value}/${resultTestSelect.value}`)
    .once("value", snap=>{
      resultBox.innerHTML="";
      snap.forEach(s=>{
        resultBox.innerHTML+=`<div>${s.key} : ${s.val().score}</div>`;
      });
    });
}

function loadTestsForTeacher(){
  testList.innerHTML="";
  firebase.database().ref(`tests/class_${manageClass.value}`).once("value", snap=>{
    snap.forEach(t=>{
      testList.innerHTML+=`<div>${t.key}</div>`;
    });
  });
}

function logout(){ auth.signOut(); }
</script>

</body>
</html>
