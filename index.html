<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Hera MCQ System</title>
<link rel="icon" href="data:,">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body { font-family: Arial; background: var(--bg-color); color: var(--text-color); transition: 0.3s; }
.box {
  width:360px; margin:40px auto; padding:20px;
  background: var(--box-bg); border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.1);
  color: var(--text-color);
}
input, select, button {
  width:100%; padding:10px; margin-top:10px;
  background: #f0f0f0; color: var(--text-color); border: 1px solid #ccc;
}
button { cursor:pointer; }
#teacherPanel, #testArea { display:none; }
.error { color:red; }
.success { color:green; }

/* Theme Variables */
:root {
  --bg-color: #f4f6f8;
  --text-color: #333;
  --accent: #ff7a18;
  --box-bg: #fff;
}

.dark-theme {
  --bg-color: #1e1e2f;
  --text-color: #fff;
  --accent: #ffb347;
  --box-bg: #111;
}

/* New Animated Login/Signup Styles */
.container{
  position:relative;
  width:800px;
  max-width:95%;
  height:450px;
  background: var(--box-bg);
  border-radius:15px;
  overflow:hidden;
  box-shadow:0 0 30px rgba(255,120,50,0.5);
}

.orange-panel{
  position:absolute;
  width:50%;
  height:100%;
  right:0;
  background: linear-gradient(135deg, var(--accent), #ffb347);
  transition:.8s ease;
  z-index:1;
}

.container.active .orange-panel{
  transform: translateX(-100%);
}

.form-box{
  position:absolute;
  width:50%;
  height:100%;
  padding:40px;
  color: var(--text-color);
  z-index:2;
}

.login-box{
  left:0;
}

.register-box{
  right:0;
  opacity:0;
  pointer-events:none;
}

.container.active .register-box{
  opacity:1;
  pointer-events:auto;
}

.container.active .login-box{
  opacity:0;
  pointer-events:none;
}

.input-box input{
  width:100%;
  padding:12px;
  border:none;
  outline:none;
  border-radius:5px;
  background: #f0f0f0;
}

button{
  width:100%;
  padding:12px;
  margin-top:15px;
  border:none;
  border-radius:5px;
  background: var(--accent);
  color: var(--text-color);
  font-size:16px;
  cursor:pointer;
  transition: 0.3s;
}

button:hover {
  opacity: 0.8;
}

.switch-btn{
  background:transparent;
  border:1px solid var(--text-color);
}

.panel-text{
  position:absolute;
  width:50%;
  height:100%;
  right:0;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  color: var(--text-color);
  text-align:center;
  padding:20px;
  z-index:3;
  transition:.8s ease;
}

.container.active .panel-text{
  transform: translateX(-100%);
}

/* Professional Test Area Styling */
#testArea {
  background: var(--box-bg);
  color: var(--text-color);
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  max-width: 800px;
  margin: 20px auto;
}

#questionBox label {
  display: block;
  margin: 10px 0;
  padding: 10px;
  background: #f9f9f9;
  border-radius: 5px;
  cursor: pointer;
  transition: 0.3s;
}

#questionBox label:hover {
  background: var(--accent);
  color: #fff;
}

#timerBox {
  font-weight: bold;
  text-align: center;
  margin-bottom: 20px;
}

/* Responsive Design */
@media (max-width: 768px) {
  .container {
    width: 90%;
    height: auto;
  }
  .form-box {
    width: 100%;
    position: static;
  }
  .orange-panel, .panel-text {
    display: none;
  }
}

/* Loading Spinner */
.loading {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid #f3f3f3;
  border-top: 3px solid var(--accent);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>
</head>

<body>

<!-- TEACHER LOGIN/SIGNUP -->
<div class="container" id="container">
  <!-- Orange Panel -->
  <div class="orange-panel"></div>

  <!-- Text Panel -->
  <div class="panel-text">
    <h1>Welcome Back!</h1>
    <p>Login to continue</p>
    <br>
    <button class="switch-btn" onclick="showRegister()">Go to Signup</button>
  </div>

  <!-- Login Form -->
  <div class="form-box login-box">
    <h2>Login</h2>
    <div class="input-box">
      <input id="tEmail" type="email" placeholder="Email" required>
    </div>
    <div class="input-box">
      <input id="tPassword" type="password" placeholder="Password" required>
    </div>
    <button onclick="teacherLogin()">Login</button>
    <p id="loginMsg" class="error"></p>
  </div>

  <!-- Register Form -->
  <div class="form-box register-box">
    <h2>Signup</h2>
    <div class="input-box">
      <input id="tEmailSignup" type="email" placeholder="Email" required>
    </div>
    <div class="input-box">
      <input id="tPasswordSignup" type="password" placeholder="Password" required>
    </div>
    <div class="input-box">
      <input id="tConfirmPassword" type="password" placeholder="Confirm Password" required>
    </div>
    <button onclick="teacherSignup()">Signup</button>
    <p id="signupMsg" class="success"></p>
    <br><br>
    <button class="switch-btn" onclick="showLogin()">Back to Login</button>
  </div>
</div>

<!-- TEACHER PANEL -->
<div class="box" id="teacherPanel">
<h3>Student Results</h3>

<select id="resultClassSelect" onchange="TestsForClass(this.value)">
<option value="">Select Class</option>
<option value="jr_kg">Jr. KG</option>
<option value="sr_kg">Sr. KG</option>
<option value="1">Class 1</option>
<option value="2">Class 2</option>
<option value="3">Class 3</option>
<option value="4">Class 4</option>
<option value="5">Class 5</option>
<option value="6">Class 6</option>
<option value="7">Class 7</option>
<option value="8">Class 8</option>
<option value="9">Class 9</option>
<option value="10">Class 10</option>
</select>
<select id="resultTestSelect"></select>
<button onclick="Results()">Results</button>
<div id="resultBox"></div>

<hr>

<h3>Create Test</h3>
<select id="testClass">
<option value="">Select Class</option>
<option value="jr_kg">Jr. KG</option>
<option value="sr_kg">Sr. KG</option>
<option value="1">Class 1</option>
<option value="2">Class 2</option>
<option value="3">Class 3</option>
<option value="4">Class 4</option>
<option value="5">Class 5</option>
<option value="6">Class 6</option>
<option value="7">Class 7</option>
<option value="8">Class 8</option>
<option value="9">Class 9</option>
<option value="10">Class 10</option>
</select>

<input id="testName" placeholder="Test Name">
<input id="testDuration" type="number" placeholder="Duration (minutes)">
<input id="questionLimit" type="number" placeholder="Questions to show (e.g. 30)">
<textarea id="bulkQuestions" rows="6"
placeholder="Question | A | B | C | D | CorrectIndex"></textarea>

<button onclick="saveTest()">Save Test</button>

<hr>

<h3>Manage Tests</h3>
<hr>
<h3>Pending Teacher Signups</h3>
<div id="pendingSignupsList"></div>
<select id="manageClass" onchange="TestsForTeacher()">
<option value="">Select Class</option>
<option value="jr_kg">Jr. KG</option>
<option value="sr_kg">Sr. KG</option>
<option value="1">Class 1</option>
<option value="2">Class 2</option>
<option value="3">Class 3</option>
<option value="4">Class 4</option>
<option value="5">Class 5</option>
<option value="6">Class 6</option>
<option value="7">Class 7</option>
<option value="8">Class 8</option>
<option value="9">Class 9</option>
<option value="10">Class 10</option>
</select>

<button id="themeToggle" onclick="toggleTheme()">Switch to Dark Theme</button>
<div id="testList"></div>
<button onclick="logout()">Logout</button>
</div>

<!-- STUDENT PANEL -->
<div class="box" id="studentPanel">
<h3>Student Test Portal</h3>
<input id="sName" placeholder="Student Name">
<input id="sRoll" placeholder="Roll Number">

<select id="sClass" onchange="TestsForClass(this.value)">
<option value="">Select Class</option>
<option value="jr_kg">Jr. KG</option>
<option value="sr_kg">Sr. KG</option>
<option value="1">Class 1</option>
<option value="2">Class 2</option>
<option value="3">Class 3</option>
<option value="4">Class 4</option>
<option value="5">Class 5</option>
<option value="6">Class 6</option>
<option value="7">Class 7</option>
<option value="8">Class 8</option>
<option value="9">Class 9</option>
<option value="10">Class 10</option>
</select>

<select id="studentTestSelect">
<option value="">Select Test</option>
</select>

<button onclick="startStudentTest()">Start Test</button>
</div>

<!-- TEST AREA -->
<div id="testArea">
<h3 id="testTitle"></h3>
<h4 id="timerBox" style="color:red"></h4>
<div id="questionBox"></div>
<button id="submitBtn" onclick="submitTest()">Submit</button>
</div>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyBQ2-dTUTPwhf7WqceEwXpk9CtPksR1xCk",
  authDomain: "hera-mcqs-55022.firebaseapp.com",
  databaseURL: "https://hera-mcqs-55022-default-rtdb.firebaseio.com"
});

const auth = firebase.auth();
let currentStudent={}, currentTest="", currentQuestions=[], studentAnswers={};
let timerInterval = null;
let remainingTime = 0; // seconds
let autoSaveInterval = null;
let currentTheme = 'light';

// Theme Toggle
function toggleTheme() {
  const body = document.body;
  const btn = document.getElementById('themeToggle');
  if (currentTheme === 'light') {
    body.classList.add('dark-theme');
    btn.innerText = 'Switch to Light Theme';
    currentTheme = 'dark';
  } else {
    body.classList.remove('dark-theme');
    btn.innerText = 'Switch to Dark Theme';
    currentTheme = 'light';
  }
}

// Show Register/Login
function showRegister(){
  document.getElementById("container").classList.add("active");
}

function showLogin(){
  document.getElementById("container").classList.remove("active");
}

function disableUnloadWarning(){
  window.onbeforeunload = null;
}

window.onbeforeunload = function () {
  if (testArea.style.display === "block") {
    return "Test is running. Leaving will submit the test.";
  }
};

window.onload = () => {
  studentPanel.style.display = "block";
};

/* LOGIN */
function teacherLogin(){
  const email = tEmail.value.trim();
  const pass = tPassword.value.trim();
  if (!email || !pass) {
    loginMsg.innerText = "Enter email and password.";
    return;
  }
  auth.signInWithEmailAndPassword(email, pass)
    .catch(e => {
      console.error("Login error:", e);
      loginMsg.innerText = e.message;
    });
}

/* SIGNUP */
function teacherSignup(){
  const email = tEmailSignup.value.trim();
  const pass = tPasswordSignup.value.trim();
  const confirmPass = tConfirmPassword.value.trim();
  if (!email || !pass || !confirmPass) {
    signupMsg.innerText = "";
    loginMsg.innerText = "Fill all fields.";
    return;
  }
  if (pass !== confirmPass) {
    signupMsg.innerText = "";
    loginMsg.innerText = "Passwords do not match.";
    return;
  }
  // Add loading
  const btn = document.querySelector('.register-box button');
  btn.innerHTML = '<div class="loading"></div> Signing up...';
  btn.disabled = true;

  const signupData = { email, password: pass };
  firebase.database().ref("pendingSignups").push(signupData)
    .then(() => {
      signupMsg.innerText = "Signup request submitted! Wait for admin approval.";
      loginMsg.innerText = "";
      tEmailSignup.value = "";
      tPasswordSignup.value = "";
      tConfirmPassword.value = "";
      btn.innerHTML = 'Signup';
      btn.disabled = false;
    })
    .catch(e => {
      console.error("Signup request failed:", e);
      loginMsg.innerText = e.message;
      btn.innerHTML = 'Signup';
      btn.disabled = false;
    });
}

auth.onAuthStateChanged(u=>{
  container.style.display = u ? "none" : "block";
  teacherPanel.style.display = u ? "block" : "none";
  if(u) {
    ResultClasses();
    loadPendingSignups(); // Load pending signups for admin
  }
});

function ResultClasses(){
  firebase.database().ref("results").once("value", snap => {

    resultClassSelect.innerHTML =
      "<option value=''>Select Class</option>";

    if(!snap.exists()) return;

    snap.forEach(cls => {
      let opt = document.createElement("option");
      opt.value = cls.key.replace("class_","");
      opt.textContent = cls.key.replace("class_","");
      resultClassSelect.appendChild(opt);
    });
  });
}

function TestsForClass(cls){
  resultTestSelect.innerHTML="<option value=''>Select Test</option>";
  studentTestSelect.innerHTML="<option value=''>Select Test</option>";

  firebase.database().ref(`tests/class_${cls}`).once("value", snap=>{
    snap.forEach(t=>{
      let o=document.createElement("option");
      o.value=o.text=t.key;
      resultTestSelect.appendChild(o.cloneNode(true));
      studentTestSelect.appendChild(o);
    });
  });
}

/* SAVE TEST */
function saveTest(){
  const cls = testClass.value;
  const name = testName.value.trim();
  const raw = bulkQuestions.value.trim();
  const duration = Number(testDuration.value);
  const limit = Number(questionLimit.value);

  if(!cls || !name || !raw || !duration || !limit){
    alert("Fill all fields including duration");
    return;
  }

  const questions = raw.split("\n").map(l=>{
    const p = l.split("|");
    return {
      q: p[0].trim(),
      options: p.slice(1,5).map(x=>x.trim()),
      answer: Number(p[5])
    };
  });

  firebase.database()
    .ref(`tests/class_${cls}/${name}`)
    .set({
      duration: duration,
      limit: limit,
      questions: questions
    })
    .then(()=>{
      alert("Test Saved with duration");
      testName.value="";
      bulkQuestions.value="";
      testDuration.value="";
      questionLimit.value="";
    });
}
function autoSaveAnswers(){
  if(!currentStudent.roll || !currentTest) return;

  firebase.database()
    .ref(`autosave/class_${currentStudent.class}/${currentTest}/${currentStudent.roll}`)
    .set({
      answers: studentAnswers,
      timeLeft: remainingTime,
      updated: Date.now()
    });
}

function shuffleArray(arr){
  for(let i = arr.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function startStudentTest(){

  const cls = sClass.value;
  const test = studentTestSelect.value;
  const roll = sRoll.value;
  const name = sName.value;

  if (!cls || !test || !roll || !name) {
    alert("Please fill all details");
    return;
  }

  firebase.database()
    .ref(`results/class_${cls}/${test}/${roll}`)
    .once("value")
    .then(rSnap => {

      if (rSnap.exists()) {
        alert("Test already submitted.\nTeacher must allow reattempt.");
        return;
      }

      currentStudent = { name, roll, class: cls };
      currentTest = test;

      firebase.database()
        .ref(`tests/class_${cls}/${test}`)
        .once("value")
        .then(snap => {

          if (!snap.exists()) {
            alert("Test not found");
            return;
          }

          const data = snap.val();

          let allQuestions = Object.values(data.questions || {});
          shuffleArray(allQuestions);

          const limit = data.limit || allQuestions.length;
          currentQuestions = allQuestions.slice(0, limit);

          studentAnswers = {};

          // â™»ï¸ Restore auto-saved answers
          firebase.database()
            .ref(`autosave/class_${cls}/${test}/${roll}`)
            .once("value")
            .then(saveSnap => {

              if (saveSnap.exists()) {
                const saved = saveSnap.val();
                studentAnswers = saved.answers || {};
                remainingTime = saved.timeLeft || (data.duration * 60);
              } else {
                remainingTime = data.duration * 60;
              }

              startTimer(Math.ceil(remainingTime / 60));
              renderTest();

              clearInterval(autoSaveInterval);
              autoSaveInterval = setInterval(autoSaveAnswers, 5000);

            });

        });

    });
}

function renderTest(){
  testTitle.innerText = `${currentTest} (${currentQuestions.length} Questions)`;
  studentPanel.style.display="none";
  testArea.style.display="block";
  questionBox.innerHTML="";
  currentQuestions.forEach((q,i)=>{
    questionBox.innerHTML+=`<b>${i+1}. ${q.q}</b><br>`+
    q.options.map((o,j)=>`<label>
    <<input type="radio" name="q${i}" 
  ${studentAnswers[i] === j ? "checked" : ""} 
  onchange="studentAnswers[${i}]=${j}">
    </label><br>`).join("")+"<hr>";
  });
}

function startTimer(minutes){
  clearInterval(timerInterval);

  remainingTime = minutes * 60;
  updateTimerDisplay();

  timerInterval = setInterval(() => {
    remainingTime--;

    updateTimerDisplay();

    if (remainingTime <= 0) {
      clearInterval(timerInterval);
      alert("Time is up! Test will be submitted automatically.");
      submitTest();
    }
  }, 1000);
}

function updateTimerDisplay(){
  const min = Math.floor(remainingTime / 60);
  const sec = remainingTime % 60;
  timerBox.innerText = `Time Left: ${min}:${sec.toString().padStart(2,'0')}`;
}

function submitTest(){

  clearInterval(autoSaveInterval);
  clearInterval(timerInterval);

  disableUnloadWarning(); // âš ï¸ must exist

  let score = 0;

  currentQuestions.forEach((q, i) => {
    if (studentAnswers[i] === q.answer) score++;
  });

  firebase.database()
    .ref(`results/class_${currentStudent.class}/${currentTest}/${currentStudent.roll}`)
    .set({
      name: currentStudent.name,
      score: score,
      total: currentQuestions.length,
      time: Date.now()
    })
    .then(() => {

      // ðŸ§¹ Remove autosave data
      firebase.database()
        .ref(`autosave/class_${currentStudent.class}/${currentTest}/${currentStudent.roll}`)
        .remove();

      alert("Test submitted successfully");
      location.reload();
    });
}

function Results(){
  const cls = resultClassSelect.value;
  const test = resultTestSelect.value;
  if(!cls || !test) return alert("Select class and test");

  firebase.database()
    .ref(`results/class_${cls}/${test}`)
    .once("value", snap => {

      resultBox.innerHTML = "";

      if(!snap.exists()){
        resultBox.innerHTML = "<p>No results</p>";
        return;
      }

      snap.forEach(r => {
        const d = r.val();

        resultBox.innerHTML += `
          <div style="border:1px solid #ccc;padding:6px;margin:6px">
            <b>${d.name}</b> (Roll: ${r.key})<br>
            Score: ${d.score}/${d.total}<br>
            <button onclick="allowReattempt('${cls}','${test}','${r.key}')">
              Allow Reattempt
            </button>
          </div>
        `;
      });
    });
}

function allowReattempt(cls, test, roll){
  if(!confirm("Allow this student to reattempt the test?")) return;

  firebase.database()
    .ref(`results/class_${cls}/${test}/${roll}`)
    .remove()
    .then(() => {
      alert("Reattempt allowed. Student can start test again.");
      Results(); // refresh list
    });
}

function TestsForTeacher() {
  const cls = manageClass.value;
  const testList = document.getElementById("testList");
  testList.innerHTML = "";
  if (!cls) return;

  firebase.database()
    .ref(`tests/class_${cls}`)
    .once("value", snap => {

      if (!snap.exists()) {
        testList.innerHTML = "<p>No tests found.</p>";
        return;
      }

      snap.forEach(t => {
        testList.innerHTML += `
          <div style="border:1px solid #ccc;padding:6px;margin:5px">
            <b>${t.key}</b><br>
            <button onclick="editTest('${cls}','${t.key}')">Edit</button>
            <button onclick="deleteTest('${cls}','${t.key}')">Delete</button>
          </div>
        `;
      });
    });
}

function editTest(cls, testName){
  firebase.database()
    .ref(`tests/class_${cls}/${testName}`)
    .once("value", snap=>{
      if(!snap.exists()) return;

      const data = snap.val();
      testClass.value = cls;
      testName.value = testName;
      testDuration.value = data.duration || "";
      questionLimit.value = data.limit || "";
      bulkQuestions.value = Object.values(data.questions)
        .map(q => `${q.q} | ${q.options.join(" | ")} | ${q.answer}`)
        .join("\n");
    });
}

function deleteTest(cls, testName){
  if(confirm("Delete this test?")){
    firebase.database().ref(`tests/class_${cls}/${testName}`).remove().then(()=>alert("Deleted"));
  }
}

function logout(){ auth.signOut(); }

function loadPendingSignups(){
  const list = document.getElementById("pendingSignupsList");
  list.innerHTML = "<p>Loading...</p>";
  firebase.database().ref("pendingSignups").once("value", snap => {
    list.innerHTML = "";
    if (!snap.exists()) {
      list.innerHTML = "<p>No pending signups.</p>";
      return;
    }
    snap.forEach(child => {
      const data = child.val();
      list.innerHTML += `
        <div style="border:1px solid #ccc;padding:6px;margin:5px">
          <b>Email:</b> ${data.email}<br>
          <button onclick="approveSignup('${child.key}', '${data.email}', '${data.password}')">Approve</button>
          <button onclick="rejectSignup('${child.key}')">Reject</button>
        </div>
      `;
    });
  });
}

function approveSignup(key, email, password){
  if (!confirm(`Approve signup for ${email}?`)) return;
  auth.createUserWithEmailAndPassword(email, password)
    .then(() => {
      firebase.database().ref(`pendingSignups/${key}`).remove();
      alert("Signup approved and user created.");
      loadPendingSignups(); // Refresh list
    })
    .catch(e => {
      console.error("Approval failed:", e);
      alert("Approval failed: " + e.message);
    });
}

function rejectSignup(key){
  if (!confirm("Reject this signup?")) return;
  firebase.database().ref(`pendingSignups/${key}`).remove()
    .then(() => {
      alert("Signup rejected.");
      loadPendingSignups(); // Refresh list
    });
}
</script>

</body>
</html>

